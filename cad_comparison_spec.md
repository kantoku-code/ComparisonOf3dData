# 3DCADデータ比較サービス 全体仕様書

## 概要
2つの3DCADデータの違いを視覚的に比較するデスクトップアプリケーション

## 技術スタック

### メインフレームワーク
- **Python Eel**: デスクトップGUI（HTML/CSS/JS + Python）
- **CadQuery**: STEPファイル読み込み・処理
- **Open3D**: 高性能メッシュ処理・STL操作
- **Three.js**: 3D表示・操作

### ファイル形式
- **入力**: STEP形式 (.step, .stp)
- **中間処理**: STL形式 (バイナリ)
- **表示**: Three.js BufferGeometry

## アーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  フロントエンド  │    │   Pythonバック   │    │   3D処理エンジン │
│                │    │     エンド       │    │               │
│ HTML/CSS/JS    │◄──►│ Eel + CadQuery  │◄──►│ Open3D + STL  │
│ Three.js       │    │                │    │               │
│ D&D UI         │    │ ファイル変換    │    │ メッシュ最適化  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 機能仕様

### 1. ファイル入力
- **方式**: ドラッグ&ドロップ
- **対応形式**: STEP (.step, .stp)
- **ファイル数**: 2つ（比較対象A・B）
- **UI**: 明確な区別表示（File A / File B）

### 2. ファイル処理パイプライン
```
STEP ファイル
    ↓ (CadQuery)
テッセレーション
    ↓ (STL出力)
STL ファイル
    ↓ (Open3D)
最適化メッシュ
    ↓ (JSON)
Three.js表示データ
```

### 3. 3D表示機能
- **表示方式**: 同一3D空間内に重ね合わせ
- **カラーリング**: 
  - File A: 赤色 (#FF4444)
  - File B: 青色 (#4444FF)
- **透明度**: 調整可能 (0.3-1.0)
- **表示切り替え**: 個別ON/OFF

### 4. 操作機能
- **視点操作**: 回転・ズーム・パン（Three.js OrbitControls）
- **表示モード**: ソリッド/ワイヤーフレーム
- **アライメント**: Open3D ICP（自動位置合わせ）
- **リセット**: 初期表示位置に戻る

### 5. 比較機能
- **視覚比較**: 重ね合わせ表示
- **距離計算**: メッシュ間最近傍距離
- **統計情報**: 平均・最大・標準偏差
- **差分ハイライト**: 閾値以上の差分を色分け

## 実装方針

### Python側処理
- **STEPファイル読み込み**: CadQueryのimporters.importStep()使用
- **メッシュ化**: tessellate()でテッセレーション実行
- **最適化**: Open3Dでメッシュクリーニング（重複頂点削除、法線計算）
- **STL出力**: 中間ファイルとして一時保存
- **データ変換**: Three.js用のJSON形式で返却

### フロントエンド構成
- **UI レイアウト**: サイドバー（コントロール） + メイン（3D表示）
- **ドラッグ&ドロップ**: HTML5 File API使用
- **3D表示**: Three.js + OrbitControls
- **マテリアル**: 透明度対応のLambertMaterial

### 主要処理フロー
1. ファイルドロップ検知
2. Python側でSTEP処理
3. メッシュデータをJavaScriptに送信
4. Three.jsでレンダリング
5. アライメント・差分計算はOpen3D処理

## インストール・セットアップ

### 必要なライブラリ

```bash
pip install eel
pip install cadquery
pip install open3d
pip install numpy
```

### ディレクトリ構成

```
project/
├── main.py                 # メインアプリケーション
├── web/
│   ├── index.html         # メインUI
│   ├── app.js            # JavaScript処理
│   └── style.css         # スタイル（オプション）
└── temp/                 # 一時STLファイル格納
```

## 実行方法

```bash
python main.py
```

## 制約・注意事項

1. **ファイルサイズ**: 大容量STEPファイル（>100MB）では処理時間が長くなる
2. **精度**: テッセレーション精度は0.1で固定（調整可能）
3. **メモリ**: 大きなメッシュでメモリ使用量が増加
4. **一時ファイル**: STLファイルが一時的に作成される

## 今後の拡張可能性

- エクスポート機能（画像、レポート）
- 測定機能（距離、角度）
- カラーマップ表示（距離に応じた色分け）
- 複数ファイル同時比較
- クラウド連携